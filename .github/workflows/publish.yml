name: 'ðŸš€ Publish Plugin'

on:
  release:
    types:
      - released
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set Version
        uses: Mudlet/xmlstarlet-action@master
        with:
          args: ed -u "Project/PropertyGroup/Version" -v "${{ github.event.release.name }}" "Directory.Build.props"

      - name: Set AssemblyVersion
        uses: Mudlet/xmlstarlet-action@master
        with:
          args: ed -u "Project/PropertyGroup/AssemblyVersion" -v "${{ github.event.release.name }}" "Directory.Build.props"

      - name: Set FileVersion
        uses: Mudlet/xmlstarlet-action@master
        with:
          args: ed -u "Project/PropertyGroup/FileVersion" -v "${{ github.event.release.name }}" "Directory.Build.props"

      - name: Setup .NET
        uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602 # v5.0.1
        with:
          dotnet-version: "9.0.x"

      - name: Build Jellyfin Plugin
        uses: oddstr13/jellyfin-plugin-repository-manager@9497a0a499416cc572ed2e07a391d9f943a37b4d # v1.1.1
        id: jprm
        with:
          dotnet-target: "net9.0"

      - name: Upload Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: build-artifact
          retention-days: 30
          if-no-files-found: error
          path: ${{ steps.jprm.outputs.artifact }}

      - name: Upload Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: version-artifact
          retention-days: 30
          if-no-files-found: error
          path: Directory.Build.props

  upload:
    needs:
      - build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_url: ${{ steps.upload_zip.outputs.browser_download_url }}
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-artifact

      - name: Prepare GH Release Assets
        run: |-
          for file in ./*; do
            md5sum ${file#./} >> ${file%.*}.md5
            sha256sum ${file#./} >> ${file%.*}.sha256
          done
          ls -l

      - name: Upload GH Release Assets
        uses: shogo82148/actions-upload-release-asset@8f6863c6c894ba46f9e676ef5cccec4752723c1e # v1.9.2
        id: upload_zip
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./*.zip

      - name: Upload GH Release md5
        uses: shogo82148/actions-upload-release-asset@8f6863c6c894ba46f9e676ef5cccec4752723c1e # v1.9.2
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./*.md5

      - name: Upload GH Release sha256
        uses: shogo82148/actions-upload-release-asset@8f6863c6c894ba46f9e676ef5cccec4752723c1e # v1.9.2
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./*.sha256

  publish:
    needs:
      - upload
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

      - name: Setup jprm
        run: |
          pip install jprm==1.1.0

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Checkout the 'master' branch to push the manifest update.
          ref: "master"

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Download Artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: version-artifact

      - name: Update manifest.json
        run: |
          jprm repo add ./ ./*.zip --plugin-url "${{ needs.upload.outputs.release_url }}"

      - name: Update build.yaml
        uses: fjogeleit/yaml-update-action@main
        with:
          valueFile: 'build.yaml'
          propertyPath: 'version'
          value: ${{ github.event.release.name }}
          commitChange: false

      - name: Commit and Push manifest.json
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add manifest.json
          git add build.yaml
          git add Directory.Build.props
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            echo "Committing updated manifest.json"
            git commit -m "ci: Update manifest.json for release ${{ github.event.release.name }}"
            git push
          fi
